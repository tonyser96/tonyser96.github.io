<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Surfshark Server Map (Latest)</title>
  <link rel="stylesheet" href="style.css" />
  <!-- MapLibre (vector) -->
  <link rel="stylesheet" href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css">
  <script defer src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
  <!-- Leaflet (raster fallback) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script defer src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<body>
  <div id="app">
    <aside id="sidebar">
      <h1>Surfshark Servers</h1>
      <input id="search" placeholder="Filter countries or citiesâ€¦" />
      <div id="list"></div>
      <footer>
        Data from <a href="https://surfshark.com/servers" target="_blank" rel="noopener">Surfshark</a>.
      </footer>
    </aside>
    <main id="map"></main>
  </div>

  <script type="module">
    const MAPTILER_KEY = localStorage.getItem('MAPTILER_KEY') || ''; // optional
    const isVector = !!MAPTILER_KEY;

    const serversUrl = '../data/servers.json';
    const countriesUrl = './countries.geojson';

    const state = { servers: {}, countries: null };

    const dom = {
      list: document.getElementById('list'),
      search: document.getElementById('search'),
    };

    // --- UI helpers ---
    function renderList(filter='') {
      const f = filter.toLowerCase().trim();
      const frag = document.createDocumentFragment();
      Object.entries(state.servers).forEach(([country, cities]) => {
        const hits = [country, ...cities].some(s => s.toLowerCase().includes(f));
        if (!hits) return;
        const div = document.createElement('div');
        div.className = 'country';
        div.innerHTML = `<h3>${country}</h3><p>${cities.join(', ') || '<i>city list unavailable</i>'}</p>`;
        div.onclick = () => zoomToCountry(country);
        frag.appendChild(div);
      });
      dom.list.replaceChildren(frag);
    }

    // --- Map init (vector first) ---
    let map, vectorLayerId = 'countries';

    async function initVector() {
      map = new maplibregl.Map({
        container: 'map',
        style: `https://api.maptiler.com/maps/streets/style.json?key=${MAPTILER_KEY}`,
        center: [10, 20], zoom: 1.6
      });
      map.addControl(new maplibregl.NavigationControl(), 'top-right');

      map.on('load', async () => {
        const srcId = 'countries';
        map.addSource(srcId, {
          type: 'geojson',
          data: countriesUrl,
          promoteId: 'NAME' // Natural Earth property
        });
        map.addLayer({
          id: vectorLayerId,
          type: 'fill',
          source: srcId,
          paint: { 'fill-color': '#4aa0ff', 'fill-opacity': 0.08 }
        });
        map.addLayer({
          id: 'country-borders',
          type: 'line',
          source: srcId,
          paint: { 'line-color': '#4aa0ff', 'line-width': 0.6, 'line-opacity': 0.5 }
        });

        map.on('click', vectorLayerId, (e) => {
          const feature = e.features?.[0];
          if (!feature) return;
          const name = feature.properties.NAME;
          zoomToCountry(name);
        });

        map.on('mousemove', vectorLayerId, () => map.getCanvas().style.cursor = 'pointer');
        map.on('mouseleave', vectorLayerId, () => map.getCanvas().style.cursor = '');

        renderList();
      });
    }

    async function initRaster() {
      map = L.map('map', { worldCopyJump: true }).setView([20, 10], 2);
      L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}@2x.png', {
        attribution: '&copy; OpenStreetMap & Carto'
      }).addTo(map);

      const resp = await fetch(countriesUrl);
      const gj = await resp.json();
      const layer = L.geoJSON(gj, {
        style: { color: '#4aa0ff', weight: 1, fillOpacity: 0.08 }
      }).addTo(map);
      layer.eachLayer(l => l.on('click', () => {
        const name = l.feature.properties.NAME;
        zoomToCountry(name);
      }));
      renderList();
    }

    async function zoomToCountry(name) {
      const feature = state.countries.features.find(f =>
        (f.properties.NAME || '').toLowerCase() === name.toLowerCase()
      );
      if (!feature) return;

      if (isVector) {
        const bbox = turf.bbox(feature);
        map.fitBounds(bbox, { padding: 40, duration: 600 });
      } else {
        const layer = L.geoJSON(feature);
        map.fitBounds(layer.getBounds(), { padding: [20, 20] });
      }
    }

    // --- Load data + boot ---
    const [servers, countries] = await Promise.all([
      fetch(serversUrl).then(r => r.json()),
      fetch(countriesUrl).then(r => r.json())
    ]);
    state.servers = servers;
    state.countries = countries;

    dom.search.addEventListener('input', e => renderList(e.target.value));

    if (isVector) {
      // load Turf (bbox) only when needed
      const s = document.createElement('script');
      s.src = 'https://unpkg.com/@turf/turf@6.5.0/turf.min.js';
      s.onload = initVector;
      document.body.appendChild(s);
    } else {
      initRaster();
    }
  </script>
</body>
</html>
